# 中文小说写作 VS Code 插件技术方案

## 项目概述

**项目名称**: Noveler
**目标**: 开发一个专门用于中文小说写作的 VS Code 插件，提供格式化、语法高亮、智能提示等功能，提升中文创作体验。

## 文件格式设计

### 文档格式选择：Markdown + Front Matter

**选择理由:**
- VS Code 原生支持，语法高亮和预览开箱即用
- 可读性强，纯文本格式便于版本管理
- 通过 Front Matter (YAML) 存储元数据，扩展性强
- 支持 HTML 注释存储插件专用标记
- 易于导出为其他格式（HTML、PDF、EPUB 等）

### 小说项目结构

```
my-novel/                      # 小说项目根目录
├── .noveler/                  # 插件配置目录（自动生成）
│   ├── config.json            # 项目配置
│   ├── characters.json        # 人物数据库
│   ├── outline.json           # 大纲数据
│   ├── timeline.json          # 时间线
│   └── stats.json             # 统计数据
├── chapters/                  # 章节目录
│   ├── 01-初入江湖.md
│   ├── 02-奇遇.md
│   └── 03-成长.md
├── drafts/                    # 草稿目录
│   └── 备用情节.md
├── references/                # 参考资料
│   ├── 世界观设定.md
│   └── 武功体系.md
└── novel.json                 # 小说元信息
```

### 章节文件格式规范

**标准章节文件示例:**

```markdown
---
title: "第一章 初入江湖"
chapter: 1
section: 1
wordCount: 3520
targetWords: 5000
characters: ["张无忌", "周芷若", "赵敏"]
locations: ["武当山", "襄阳城"]
tags: ["武侠", "成长", "初遇"]
timeline: "明朝洪武年间"
created: 2025-11-18T10:00:00
modified: 2025-11-18T15:30:00
status: "草稿"  # 草稿 | 初稿 | 修改中 | 完成
---

# 第一章 初入江湖

## 第一节 清晨

清晨的阳光透过窗棂洒在青石板上。

"师父，我想下山。"张无忌低声说道。

<!-- noveler:scene 场景：武当山大殿 -->
<!-- noveler:character 人物：张无忌 情绪：忐忑 -->

老道长抚须而笑："孩子，江湖险恶，你可想清楚了？"

<!-- noveler:dialog speaker="张三丰" emotion="慈祥" -->

## 第二节 下山

...

<!-- noveler:note 作者备注：这里需要补充更多心理描写 -->
```

### 元数据字段说明

**Front Matter 字段:**

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| title | string | 章节标题 | ✓ |
| chapter | number | 章节号 | ✓ |
| section | number | 节号 | - |
| wordCount | number | 字数（自动统计） | - |
| targetWords | number | 目标字数 | - |
| characters | string[] | 出场人物 | - |
| locations | string[] | 场景地点 | - |
| tags | string[] | 标签 | - |
| timeline | string | 时间线 | - |
| created | datetime | 创建时间 | - |
| modified | datetime | 修改时间 | - |
| status | enum | 状态 | - |
| summary | string | 章节摘要 | - |

**HTML 注释标记:**

```markdown
<!-- noveler:scene 场景描述 -->
<!-- noveler:character name="人物名" emotion="情绪" -->
<!-- noveler:dialog speaker="说话人" emotion="情绪" -->
<!-- noveler:note 作者备注 -->
<!-- noveler:todo 待办事项 -->
<!-- noveler:highlight 重点标记 -->
```

### 项目配置文件

**novel.json - 小说元信息:**

```json
{
  "title": "我的武侠小说",
  "author": "作者名",
  "genre": "武侠",
  "description": "一个少年的成长之路",
  "targetWords": 500000,
  "language": "zh-CN",
  "created": "2025-11-18",
  "chapters": [
    {
      "file": "chapters/01-初入江湖.md",
      "title": "第一章 初入江湖",
      "order": 1
    }
  ],
  "settings": {
    "autoSave": true,
    "autoBackup": true,
    "formatOnSave": true
  }
}
```

**.noveler/characters.json - 人物数据库:**

```json
{
  "characters": [
    {
      "id": "char_001",
      "name": "张无忌",
      "aliases": ["无忌", "张公子"],
      "description": "主角，善良正直",
      "attributes": {
        "age": 18,
        "gender": "男",
        "appearance": "眉清目秀",
        "personality": "善良、犹豫"
      },
      "relationships": [
        {
          "character": "周芷若",
          "relation": "青梅竹马"
        }
      ],
      "firstAppearance": "chapters/01-初入江湖.md",
      "appearances": [1, 2, 5, 8]
    }
  ]
}
```

### 文件格式优势

1. **版本控制友好**: 纯文本格式，Git 可以清晰显示差异
2. **平台无关**: 任何文本编辑器都能打开和编辑
3. **结构化与可读性平衡**: Markdown 语法简单，不影响阅读
4. **可扩展性**: 通过注释和 Front Matter 扩展功能
5. **导出灵活**: 可转换为各种出版格式
6. **智能提示基础**: 结构化数据便于实现智能功能

## 技术选型

### 核心技术栈

| 技术 | 选择 | 理由 |
|------|------|------|
| 开发语言 | TypeScript | VS Code 插件官方推荐，类型安全，开发效率高 |
| 插件框架 | VS Code Extension API | 官方 API，功能完备 |
| 语言服务 | Language Server Protocol (LSP) | 提供高性能的语言功能支持 |
| 中文处理 | nodejieba + @node-rs/jieba | 高性能中文分词库 |
| 语法高亮 | TextMate Grammar | VS Code 原生支持，性能优秀 |
| UI 框架 | VS Code WebView + React | 复杂界面组件开发 |
| 数据存储 | SQLite3 + better-sqlite3 | 本地数据库，存储用户配置和词库 |
| 构建工具 | Webpack + esbuild | 插件打包优化 |

### 第三方库依赖

```json
{
  "dependencies": {
    "vscode": "^1.74.0",
    "@node-rs/jieba": "^1.6.0",
    "better-sqlite3": "^8.7.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/vscode": "^1.74.0",
    "@types/react": "^18.0.0",
    "webpack": "^5.75.0",
    "esbuild-loader": "^2.20.0",
    "typescript": "^4.9.0"
  }
}
```

## 功能架构设计

### 核心功能模块

#### 1. 语法高亮模块 (Syntax Highlighting)

**文件结构:**
```
syntaxes/
├── chinese-novel.tmLanguage.json  # TextMate 语法规则
└── themes/
    ├── novel-light.json           # 浅色主题
    └── novel-dark.json            # 深色主题
```

**高亮规则:**
- **对话内容**: `"..."` 或 `「...」`
- **心理描述**: `（...）`
- **环境描写**: 以特定关键词开头的句子
- **动作描述**: 包含动作词汇的句子
- **人物名称**: 预定义人物名称列表
- **时间地点**: 时间和地点相关词汇

#### 2. 智能提示模块 (IntelliSense)

**实现方式**:
```typescript
// src/providers/completionProvider.ts
export class NovelCompletionProvider implements vscode.CompletionItemProvider {
  provideCompletionItems(document, position, token, context) {
    // 根据上下文提供不同类型的补全
    // 1. 人物名称补全
    // 2. 场景描述模板
    // 3. 情感词汇提示
    // 4. 常用句式补全
  }
}
```

**提示类型:**
- **人物补全**: 基于已出现的人物名称
- **情感词汇**: 预设情感描述词库
- **场景模板**: 常用场景描述模板
- **对话标签**: 对话相关的描述词
- **动作词汇**: 人物动作描述词库

#### 3. 文档格式化模块 (Formatting)

**格式化规则:**
```typescript
// src/providers/formatProvider.ts
export class NovelFormatProvider implements vscode.DocumentFormattingEditProvider {
  provideDocumentFormattingEdits(document, options, token) {
    // 1. 对话格式标准化
    // 2. 段落间距调整
    // 3. 章节标题格式化
    // 4. 标点符号规范化
  }
}
```

#### 4. 辅助功能模块 (Assistant Features)

**4.1 人物管理 (Character Management)**
```typescript
interface Character {
  name: string;
  aliases: string[];      // 别名
  description: string;    // 人物描述
  relationships: string[]; // 人物关系
  appearances: number[];   // 出现章节
}
```

**4.2 章节大纲 (Chapter Outline)**
```typescript
interface Chapter {
  title: string;
  summary: string;
  wordCount: number;
  characters: string[];
  scenes: Scene[];
}
```

**4.3 字数统计 (Word Count)**
- 实时字数统计
- 章节字数统计
- 目标进度追踪

## 技术实现方案

### 1. 项目结构

```
noveler/
├── package.json
├── tsconfig.json
├── webpack.config.js
├── src/
│   ├── extension.ts              # 插件入口
│   ├── providers/                # 功能提供者
│   │   ├── completionProvider.ts
│   │   ├── formatProvider.ts
│   │   ├── hoverProvider.ts
│   │   └── definitionProvider.ts
│   ├── services/                 # 核心服务
│   │   ├── characterService.ts
│   │   ├── dictionaryService.ts
│   │   ├── formatService.ts
│   │   └── statisticsService.ts
│   ├── utils/                    # 工具函数
│   │   ├── chineseUtils.ts
│   │   ├── textUtils.ts
│   │   └── regexPatterns.ts
│   ├── webview/                  # WebView 组件
│   │   ├── characterPanel/
│   │   ├── outlinePanel/
│   │   └── statsPanel/
│   └── data/                     # 数据文件
│       ├── dictionaries/
│       ├── templates/
│       └── schemas/
├── syntaxes/                     # 语法文件
├── themes/                       # 主题文件
├── icons/                        # 图标资源
└── test/                        # 测试文件
```

### 2. 语言服务器实现

**Language Server 架构:**
```typescript
// src/server/server.ts
import {
  createConnection,
  TextDocuments,
  ProposedFeatures,
  InitializeParams,
  CompletionItem,
  TextDocumentPositionParams
} from 'vscode-languageserver';

const connection = createConnection(ProposedFeatures.all);
const documents: TextDocuments<TextDocument> = new TextDocuments(TextDocument);

// 实现各种语言功能
connection.onCompletion(handleCompletion);
connection.onCompletionResolve(handleCompletionResolve);
connection.onHover(handleHover);
```

### 3. 中文处理实现

**分词和词性标注:**
```typescript
// src/services/chineseProcessor.ts
import { load } from '@node-rs/jieba';

export class ChineseProcessor {
  private jieba = load();

  // 文本分词
  segmentText(text: string): string[] {
    return this.jieba.cut(text, false);
  }

  // 提取人物名称
  extractCharacters(text: string): string[] {
    // 基于词性标注和规则匹配
  }

  // 提取场景描述
  extractScenes(text: string): string[] {
    // 基于关键词和语境分析
  }
}
```

### 4. WebView 界面开发

**人物管理面板:**
```tsx
// src/webview/characterPanel/CharacterPanel.tsx
import React, { useState, useEffect } from 'react';

interface CharacterPanelProps {
  vscode: any;
}

export const CharacterPanel: React.FC<CharacterPanelProps> = ({ vscode }) => {
  const [characters, setCharacters] = useState<Character[]>([]);

  // 组件实现...
  return (
    <div className="character-panel">
      {/* 人物列表和编辑界面 */}
    </div>
  );
};
```

## 性能优化策略

### 1. 语法高亮优化
- 使用增量解析，只更新变更部分
- 异步处理大文件
- 缓存解析结果

### 2. 智能提示优化
- 延迟加载词库
- 使用 Trie 树结构优化检索
- 限制提示数量避免性能问题

### 3. 内存管理
- 及时清理不用的缓存
- 使用 WeakMap 避免内存泄漏
- 分页加载大型词库

## 开发计划

### 第一阶段 (MVP - 4 周)
1. **Week 1**: 项目初始化，基础语法高亮
2. **Week 2**: 基础智能提示功能
3. **Week 3**: 文档格式化功能
4. **Week 4**: 基础字数统计，发布 MVP

### 第二阶段 (功能完善 - 6 周)
1. **Week 5-6**: 人物管理系统
2. **Week 7-8**: 章节大纲功能
3. **Week 9**: 主题和配置系统
4. **Week 10**: 性能优化和 bug 修复

### 第三阶段 (高级功能 - 4 周)
1. **Week 11-12**: AI 写作助手集成
2. **Week 13**: 云同步功能
3. **Week 14**: 发布正式版

## 质量保证

### 测试策略
- **单元测试**: Jest + VS Code Test Framework
- **集成测试**: 端到端功能测试
- **性能测试**: 大文件处理性能测试
- **用户测试**: Beta 版本用户反馈

### 代码质量
- ESLint + Prettier 代码规范
- Husky + lint-staged 提交前检查
- TypeScript 严格模式
- 代码覆盖率 > 80%

## 风险评估与应对

### 技术风险
1. **中文处理复杂性**: 采用成熟的 jieba 分词库，建立词库更新机制
2. **性能问题**: 实施增量更新和缓存策略
3. **兼容性问题**: 充分测试不同 VS Code 版本

### 用户体验风险
1. **学习成本**: 提供详细文档和教程
2. **功能复杂度**: 采用渐进式功能开放策略
3. **个性化需求**: 提供灵活的配置选项

## 总结

本技术方案为中文小说写作 VS Code 插件提供了完整的技术架构和实现路径。通过模块化设计、性能优化和质量保证，确保插件能够满足中文创作者的专业需求，提供流畅的写作体验。